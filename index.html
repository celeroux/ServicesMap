<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Services Map</title>
  <style>
    #map {
      height: 100vh; /* Full height of the viewport */
      width: 100%;   /* Full width of the viewport */
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChrxf8It3o8fAaaAQRI0zsBaEtoVtqt2I&callback=initMap" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    let map;
    let geocoder;

    // Mapping each category to a specific colored marker icon
    const categoryIcons = {
      'Emergency Shelter Services': 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      'Free Legal Services': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      'Open Work Permit Support': 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
      'Counseling Services': 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png',
      'Health Services': 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
    };

    // Default icon if a category does not match any key
    const defaultIconUrl = 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 45.5116, lng: -66.1194 }, // Default center of the map
        zoom: 6 // Default zoom level
      });
      geocoder = new google.maps.Geocoder(); // Initialize the geocoder
      loadSheetData();
    }

    function loadSheetData() {
      const apiKey = 'AIzaSyChrxf8It3o8fAaaAQRI0zsBaEtoVtqt2I';
      const sheetId = '1ghAvyWpBIP7bkzC0lkEFynnjzkI3VrMLYCSmwssgNyk';
      const range = 'Sheet1!A:C'; // Ensure the range covers Address, Category, and Title

      gapi.load('client', () => {
        gapi.client.init({
          apiKey: apiKey,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
        }).then(() => {
          return gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: sheetId,
            range: range
          });
        }).then(response => {
          const rows = response.result.values;
          if (rows.length > 0) {
            // Skip the header row and iterate over data rows
            rows.forEach((row, index) => {
              if (index > 0 && row.length >= 3) {
                const address = row[0];   // Column A: Address
                const category = row[1];  // Column B: Category
                const title = row[2];     // Column C: Title
                geocodeAddress(address, category, title);
              }
            });
          }
        }, function(response) {
          console.error('Error: ' + response.result.error.message);
        });
      });
    }

    function geocodeAddress(address, category, title) {
      geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
          // Optionally center the map on the first successful geocode
          map.setCenter(results[0].geometry.location);
          addMarker(results[0].geometry.location, title, category);
        } else {
          console.error('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    function addMarker(location, title, category) {
      // Normalize category string to remove extra whitespace
      const normalizedCategory = category.trim();
      const iconUrl = categoryIcons[normalizedCategory] || defaultIconUrl;
      
      // Debug log to verify category values and chosen icon
      console.log("Adding marker:", title, "Category:", normalizedCategory, "Icon URL:", iconUrl);

      new google.maps.Marker({
        position: location,
        map: map,
        title: title,
        icon: iconUrl
      });
    }
  </script>
</body>
</html>
