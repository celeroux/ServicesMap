<script>
    const categoryColors = {
        "Emergency Food Services": 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
        "Free Legal Services": 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
        "Open Work Permit Support": 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
        "Counseling Services": 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
        "Health Services": 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png',
    };

    let map;
    let geocoder;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 45.5116, lng: -66.1194 },
            zoom: 8
        });
        geocoder = new google.maps.Geocoder();
        loadSheetData();
    }

    function loadSheetData() {
        gapi.load('client', () => {
            gapi.client.init({
                apiKey: 'AIzaSyChrxf8It3o8fAaaAQRI0zsBaEtoVtqt2I',
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            }).then(() => {
                return gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: '1ghAvyWpBIP7bkzC0lkEFynnjzkI3VrMLYCSmwssgNyk',
                    range: 'Sheet1!A:G',
                });
            }).then(response => {
                console.log("Sheet data loaded:", response.result.values); // Log the data fetched
                const rows = response.result.values;
                if (rows.length > 0) {
                    rows.forEach((row, index) => {
                        if (index > 0 && row.length >= 3) { // Skip header and ensure data completeness
                            const address = row[0];
                            const title = row[2];
                            const category = row[1]; // Category in column B
                            console.log(`Geocoding address [${index}]:`, address, title, category); // Log each address being geocoded
                            geocodeAddress(address, title, category);
                        }
                    });
                }
            }, function(response) {
                console.error('Error loading sheet data:', response.result.error.message);
            });
        });
    }

    function geocodeAddress(address, title, category) {
        geocoder.geocode({'address': address}, function(results, status) {
            console.log(`Geocoding result for [${address}]:`, results, status); // Log geocoding results
            if (status === 'OK') {
                addMarker(results[0].geometry.location, title, category);
            } else {
                console.error('Geocode was not successful for the following reason:', status);
            }
        });
    }

    function addMarker(location, title, category) {
        const markerIcon = categoryColors[category] || 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'; // Default if category unknown
        console.log(`Adding marker at:`, location, `for`, title, `with icon`, markerIcon); // Log marker addition
        const marker = new google.maps.Marker({
            position: location,
            map: map,
            title: title,
            icon: markerIcon
        });
    }
</script>
